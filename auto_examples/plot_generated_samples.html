

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analyze a post-training Bernoulli-Bernoulli RBM &mdash; Torch RBM 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Torch RBM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Analyze a post-training Bernoulli-Bernoulli RBM</a><ul>
<li><a class="reference internal" href="#load-the-dataset">Load the dataset</a></li>
<li><a class="reference internal" href="#load-the-model">Load the model.</a></li>
<li><a class="reference internal" href="#sample-the-rbm">Sample the RBM</a></li>
<li><a class="reference internal" href="#compute-the-ais-estimation-of-the-log-likelihood">Compute the AIS estimation of the log-likelihood.</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Torch RBM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Analyze a post-training Bernoulli-Bernoulli RBM</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/auto_examples/plot_generated_samples.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-plot-generated-samples-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="analyze-a-post-training-bernoulli-bernoulli-rbm">
<span id="sphx-glr-auto-examples-plot-generated-samples-py"></span><h1>Analyze a post-training Bernoulli-Bernoulli RBM<a class="headerlink" href="#analyze-a-post-training-bernoulli-bernoulli-rbm" title="Link to this heading"></a></h1>
<p>This script shows how to analyze the RBM after having trained it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
</pre></div>
</div>
<section id="load-the-dataset">
<h2>Load the dataset<a class="headerlink" href="#load-the-dataset" title="Link to this heading"></a></h2>
<p>We suppose the RBM was trained on the <cite>dummy.h5</cite> dataset file, with 60% of the train dataset.
By default, the dataset splitting is seeded. So just putting the same train_size and test_size ensures
having the same split for analysis. This behaviour can be changed by setting a different value to the <cite>seed</cite> keyword.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
    <span class="s2">&quot;dummy.h5&quot;</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
<span class="p">)</span>
<span class="n">num_visibles</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_num_visibles</span><span class="p">()</span>

<span class="n">U_data</span><span class="p">,</span> <span class="n">S_data</span><span class="p">,</span> <span class="n">V_dataT</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">proj_data</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">@</span> <span class="n">V_dataT</span><span class="o">.</span><span class="n">mT</span> <span class="o">/</span> <span class="n">num_visibles</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">proj_data</span> <span class="o">=</span> <span class="n">proj_data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="load-the-model">
<h2>Load the model.<a class="headerlink" href="#load-the-model" title="Link to this heading"></a></h2>
<p>First, we want to know which machines have been saved</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_saved_updates</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;RBM.h5&quot;</span>
<span class="n">saved_updates</span> <span class="o">=</span> <span class="n">get_saved_updates</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved updates: </span><span class="si">{</span><span class="n">saved_updates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Saved updates: [    1     2     3     4     5     7     8    10    13    16    20    25
    31    39    49    61    75    94   116   145   180   223   277   344
   427   531   659   765   819   849   990  1017  1024  1262  1567  1568
  1946  2118  2391  2416  2655  3000  3725  3799  4625  5743  7033  7131
  8853 10992 13648 16946 18038 21040 26123 31967 32434 40270 42529 50000]
</pre></div>
</div>
<p>Now we will load the last saved model as well as the permanent chains during training
Only the configurations associated to the last saved model have been saved for the permanent chains.
We also get access to the hyperparameters of the RBM training as well as the time elapsed during the training.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_model</span>

<span class="n">params</span><span class="p">,</span> <span class="n">permanent_chains</span><span class="p">,</span> <span class="n">training_time</span><span class="p">,</span> <span class="n">hyperparameters</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">saved_updates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time: </span><span class="si">{</span><span class="n">training_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hyperparameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">hyperparameters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Training time: 4915.106016874313
batch_size : 2000
gibbs_steps : 5
learning_rate : 0.01
</pre></div>
</div>
<p>To follow the training of the RBM, let’s look at the singular values of the weight matrix</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_eigenvalues_history</span>

<span class="n">grad_updates</span><span class="p">,</span> <span class="n">sing_val</span> <span class="o">=</span> <span class="n">get_eigenvalues_history</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grad_updates</span><span class="p">,</span> <span class="n">sing_val</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Training time (gradient updates)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Singular values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_generated_samples_001.png" srcset="../_images/sphx_glr_plot_generated_samples_001.png" alt="plot generated samples" class = "sphx-glr-single-img"/><p>Let’s compare the permanent chains to the dataset distribution. To do so, we project the chains on the first
principal components of the dataset.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_PCA</span>

<span class="n">proj_pc</span> <span class="o">=</span> <span class="n">permanent_chains</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="n">V_dataT</span><span class="o">.</span><span class="n">mT</span> <span class="o">/</span> <span class="n">num_visibles</span><span class="o">**</span><span class="mf">0.5</span>

<span class="n">plot_PCA</span><span class="p">(</span>
    <span class="n">proj_data</span><span class="p">,</span>
    <span class="n">proj_pc</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;Permanent chains&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_generated_samples_002.png" srcset="../_images/sphx_glr_plot_generated_samples_002.png" alt="plot generated samples" class = "sphx-glr-single-img"/></section>
<section id="sample-the-rbm">
<h2>Sample the RBM<a class="headerlink" href="#sample-the-rbm" title="Link to this heading"></a></h2>
<p>Another interesting thing is to compare generated samples starting from random configurations</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.sampling.gibbs</span><span class="w"> </span><span class="kn">import</span> <span class="n">sample_state</span>

<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">chains</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">init_chains</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
<span class="n">proj_gen_init</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="n">V_dataT</span><span class="o">.</span><span class="n">mT</span> <span class="o">/</span> <span class="n">num_visibles</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">plot_PCA</span><span class="p">(</span>
    <span class="n">proj_data</span><span class="p">,</span>
    <span class="n">proj_gen_init</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;Starting position&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_generated_samples_003.png" srcset="../_images/sphx_glr_plot_generated_samples_003.png" alt="plot generated samples" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/nbereux/work/rbms/examples/plot_generated_samples.py:100: UserWarning: Tight layout not applied. tight_layout cannot make Axes width small enough to accommodate all Axes decorations
  plt.tight_layout()
</pre></div>
</div>
<p>We can now sample those chains and compare again the distribution</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">n_steps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">chains</span> <span class="o">=</span> <span class="n">sample_state</span><span class="p">(</span><span class="n">gibbs_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="n">proj_gen</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="s2">&quot;visible&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="n">V_dataT</span><span class="o">.</span><span class="n">mT</span> <span class="o">/</span> <span class="n">num_visibles</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">plot_PCA</span><span class="p">(</span>
    <span class="n">proj_data</span><span class="p">,</span>
    <span class="n">proj_gen</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;Generated samples&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_generated_samples_004.png" srcset="../_images/sphx_glr_plot_generated_samples_004.png" alt="plot generated samples" class = "sphx-glr-single-img"/></section>
<section id="compute-the-ais-estimation-of-the-log-likelihood">
<h2>Compute the AIS estimation of the log-likelihood.<a class="headerlink" href="#compute-the-ais-estimation-of-the-log-likelihood" title="Link to this heading"></a></h2>
<p>For now, we only looked at a qualitative evaluation of the model</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rbms.partition_function.ais</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_partition_function_ais</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rbms.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_log_likelihood</span>

<span class="n">log_z_ais</span> <span class="o">=</span> <span class="n">compute_partition_function_ais</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">num_beta</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="n">compute_log_likelihood</span><span class="p">(</span>
        <span class="n">train_dataset</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">log_z</span><span class="o">=</span><span class="n">log_z_ais</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>-387.64599609375
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 8.271 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-generated-samples-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/2ab02bd8f1bb0dadada5433b57665b27/plot_generated_samples.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_generated_samples.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/2aa2445c2249946a3d39b0dc84cbbb54/plot_generated_samples.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_generated_samples.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">plot_generated_samples.zip</span></code></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Nicolas Béreux.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>